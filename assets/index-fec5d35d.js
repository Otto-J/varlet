import{H as be,u as we}from"./index-0e1865c0.js";import{F as Ve,u as Re}from"./provide-2ddabd0a.js";import{I as Pe}from"./index-80d7ed9c.js";import{P as Be}from"./index-a9a5edc2.js";import{I as Q}from"./index-643aa5bc.js";import{v as $e}from"./index-e1852767.js";import{v as ke}from"./index-6aa4e967.js";import{d as m,h as Ce,a as v,f as Se,c as Te,w as De}from"./components-c42be6d1.js";import{d as Le,r as z,D as X,ae as Ue,G as Fe,a4 as M,ac as Y,W as V,aR as A,n as He,b4 as Ne,_ as ze,b as S,L as Z,e as c,m as p,p as R,N as Me,O as Ae,P as _,x as i,R as Ie,M as Ee,q as P,t as T,y as x,v as ee,aM as Oe,w as ae}from"./index-928d25ab.js";import{i as le,a as oe}from"./shared-1d3159b4.js";import{a as We}from"./elements-54f7dee6.js";const je={modelValue:{type:Array,default:()=>[]},accept:{type:String,default:"image/*"},capture:{type:[String,Boolean],default:void 0},multiple:Boolean,readonly:Boolean,disabled:Boolean,elevation:{type:[Boolean,Number,String],default:!0},resolveType:{type:String,default:"default"},removable:{type:Boolean,default:!0},maxlength:[Number,String],maxsize:[Number,String],previewed:{type:Boolean,default:!0},ripple:{type:Boolean,default:!0},validateTrigger:{type:Array,default:()=>["onChange","onRemove"]},rules:Array,hideList:Boolean,onBeforeFilter:m(),onBeforeRead:m(),onAfterRead:m(),onBeforeRemove:m(),onRemove:m(),onOversize:m(),"onUpdate:modelValue":m()},{name:qe,n:Ge,classes:Je}=Te("uploader");let Ke=0;const Qe=Le({name:qe,directives:{Ripple:$e,Hover:ke},components:{VarIcon:Pe,VarPopup:Be,VarFormDetails:Ve,VarHoverOverlay:be},props:je,setup(e){const d=z(null),B=z(!1),$=z(null),I=X(()=>{const{maxlength:a,modelValue:{length:r}}=e;return Ue(a)?`${r} / ${a}`:""}),{form:o,bindForm:k}=Re(),{errorMessage:D,validateWithTrigger:L,validate:U,resetValidation:f}=Ce(),{hovering:F,handleHovering:l}=we(),g=X(()=>{const{modelValue:a,hideList:r}=e;return r?[]:a});let H=!1;const E={getSuccess:O,getError:W,getLoading:j};v(k,{validate:G,resetValidation:f,reset:J}),Fe(()=>e.modelValue,()=>{!H&&q("onChange"),H=!1},{deep:!0});function re(a){const{disabled:r,previewed:t}=e;if(o!=null&&o.disabled.value||r||!t)return;const{url:s}=a;if(Y(s)&&oe(s)){Q(s);return}Y(s)&&le(s)&&($.value=a,B.value=!0)}function se(a){return{id:Ke++,url:"",cover:"",name:a.name,file:a,progress:0}}function ne(a){const r=a.target,{files:t}=r;return Array.from(t)}async function te(a){if(e.resolveType==="data-url"||a.file.type.startsWith("image")&&e.resolveType==="default"){const r=await Ne(a.file);a.cover=r,a.url=r}return a}function ie(a){return a.map(te)}function de(a){const{onBeforeRead:r}=e;return a.map(t=>new Promise(s=>{r||s({valid:!0,varFile:t});const y=A(v(r,V(t)));Promise.all(y).then(b=>{s({valid:b.every(Boolean),varFile:t})})}))}async function ue(a){const{maxsize:r,maxlength:t,modelValue:s,onOversize:y,onAfterRead:b,onBeforeFilter:C,readonly:w,disabled:N}=e;if(o!=null&&o.disabled.value||o!=null&&o.readonly.value||N||w)return;const pe=n=>n.filter(h=>h.file.size>M(r)?(v(y,V(h)),!1):!0),fe=n=>{const h=Math.min(n.length,M(t)-s.length);return n.slice(0,h)},ge=async n=>{if(!C)return n;const h=A(C);for(const he of h)n=await he(n);return n};let u=ne(a).map(se);u=await ge(u),u=r!=null?pe(u):u,u=t!=null?fe(u):u;const ye=await Promise.all(ie(u)),K=(await Promise.all(de(ye))).filter(({valid:n})=>n).map(({varFile:n})=>n);v(e["onUpdate:modelValue"],[...s,...K]),a.target.value="",K.forEach(n=>v(b,V(n)))}async function ve(a){const{disabled:r,readonly:t,modelValue:s,onBeforeRemove:y,onRemove:b}=e;if(o!=null&&o.disabled.value||o!=null&&o.readonly.value||r||t)return;if(y){const w=A(v(y,V(a)));if((await Promise.all(w)).some(N=>!N))return}const C=s.filter(w=>w!==a);v(b,V(a)),q("onRemove"),v(e["onUpdate:modelValue"],C)}function O(){return e.modelValue.filter(a=>a.state==="success")}function W(){return e.modelValue.filter(a=>a.state==="error")}function j(){return e.modelValue.filter(a=>a.state==="loading")}function me(){d.value.click()}function ce(){$.value=null,B.value=!1,Q.close()}function q(a){He(()=>{const{validateTrigger:r,rules:t,modelValue:s}=e;L(r,a,t,s,E)})}function G(){return U(e.rules,e.modelValue,E)}function J(){H=!0,v(e["onUpdate:modelValue"],[]),f()}return{input:d,files:g,showPreview:B,currentPreview:$,errorMessage:D,maxlengthText:I,hovering:F,formDisabled:o==null?void 0:o.disabled,formReadonly:o==null?void 0:o.readonly,n:Ge,classes:Je,formatElevation:Se,toNumber:M,handleHovering:l,isHTMLSupportVideo:le,isHTMLSupportImage:oe,preview:re,handleChange:ue,handleRemove:ve,getSuccess:O,getError:W,getLoading:j,validate:G,resetValidation:f,reset:J,chooseFile:me,closePreview:ce,toSizeUnit:We}}});const Xe=["onClick"],Ye=["onClick"],Ze=["src","alt"],_e=["multiple","accept","capture","disabled"],xe=["src"];function ea(e,d,B,$,I,o){const k=S("var-icon"),D=S("var-hover-overlay"),L=S("var-form-details"),U=S("var-popup"),f=Z("ripple"),F=Z("hover");return c(),p("div",{class:i(e.classes(e.n(),e.n("$--box")))},[R("div",{class:i(e.n("file-list"))},[(c(!0),p(Me,null,Ae(e.files,l=>_((c(),p("div",{class:i(e.classes(e.n("file"),e.formatElevation(e.elevation,2),[l.state==="loading",e.n("--loading")])),key:l.id,onClick:g=>e.preview(l)},[R("div",{class:i(e.n("file-name"))},Ie(l.name||l.url),3),e.removable?(c(),p("div",{key:0,class:i(e.n("file-close")),onClick:Ee(g=>e.handleRemove(l),["stop"])},[P(k,{class:i(e.n("file-close-icon")),"var-uploader-cover":"",name:"delete"},null,8,["class"])],10,Ye)):T("",!0),l.cover?(c(),p("img",{key:1,class:i(e.n("file-cover")),style:x({objectFit:l.fit}),src:l.cover,alt:l.name},null,14,Ze)):T("",!0),R("div",{class:i(e.n("file-indicator"))},[R("div",{class:i(e.classes(e.n("progress"),[l.state==="success",e.n("--success")],[l.state==="error",e.n("--error")])),style:x({width:l.state==="success"||l.state==="error"?"100%":`${l.progress}%`})},null,6)],2)],10,Xe)),[[f,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple}]])),128)),!e.maxlength||e.modelValue.length<e.toNumber(e.maxlength)?_((c(),p("div",{key:0,class:i(e.classes([!e.$slots.default,`${e.n("action")} ${e.formatElevation(e.elevation,2)}`],[e.disabled||e.formDisabled,e.n("--disabled")])),onClick:d[1]||(d[1]=(...l)=>e.chooseFile&&e.chooseFile(...l))},[R("input",{ref:"input",type:"file",class:i(e.n("action-input")),multiple:e.multiple,accept:e.accept,capture:e.capture,disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly,onChange:d[0]||(d[0]=(...l)=>e.handleChange&&e.handleChange(...l))},null,42,_e),ee(e.$slots,"default",{},()=>[P(k,{class:i(e.n("action-icon")),"var-uploader-cover":"",name:"plus"},null,8,["class"]),P(D,{hovering:e.hovering&&!e.disabled&&!e.formDisabled},null,8,["hovering"])])],2)),[[f,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple||!!e.$slots.default}],[F,e.handleHovering,"desktop"]]):T("",!0)],2),P(L,{"error-message":e.errorMessage,"extra-message":e.maxlengthText},Oe({_:2},[e.$slots["extra-message"]?{name:"extra-message",fn:ae(()=>[ee(e.$slots,"extra-message")]),key:"0"}:void 0]),1032,["error-message","extra-message"]),P(U,{class:i(e.n("preview")),"var-uploader-cover":"",position:"center",show:e.showPreview,"onUpdate:show":d[2]||(d[2]=l=>e.showPreview=l),onClosed:d[3]||(d[3]=l=>e.currentPreview=null)},{default:ae(()=>{var l,g;return[e.currentPreview&&e.isHTMLSupportVideo((l=e.currentPreview)==null?void 0:l.url)?(c(),p("video",{key:0,class:i(e.n("preview-video")),playsinline:"true","webkit-playsinline":"true","x5-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"false",controls:"",src:(g=e.currentPreview)==null?void 0:g.url},null,10,xe)):T("",!0)]}),_:1},8,["class","show"])],2)}const aa=ze(Qe,[["render",ea]]);De(aa);export{aa as U};
