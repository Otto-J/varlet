import{H as we,u as Ve}from"./index-8932df76.js";import{F as Re,u as Pe}from"./provide-b01a0eec.js";import{I as Be}from"./index-a00d271a.js";import{P as ke}from"./index-830ff231.js";import{I as G}from"./index-85c1eebf.js";import{v as $e}from"./index-92086fe4.js";import{v as Ce}from"./index-a474ec93.js";import{d as c,k as Se,a as v,f as De,c as Fe}from"./logger-928e8198.js";import{d as Ue,a as z,b as J,X as He,w as Le,Z as A,W as Y,r as V,aO as M,n as Ne,_ as Te,p as S,ag as _,f as p,h as f,M as R,F as ze,ai as Ae,D as x,N as i,Q as Me,ah as Oe,q as P,j as D,R as ee,O as ae,aK as Ee,S as le}from"./vue-router-d12202db.js";import{A as se,B as oe,a as Ie}from"./elements-ab6c30e6.js";const We={modelValue:{type:Array,default:()=>[]},accept:{type:String,default:"image/*"},capture:{type:[String,Boolean],default:void 0},multiple:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},elevation:{type:[Boolean,Number,String],default:!0},removable:{type:Boolean,default:!0},maxlength:{type:[Number,String]},maxsize:{type:[Number,String]},previewed:{type:Boolean,default:!0},ripple:{type:Boolean,default:!0},validateTrigger:{type:Array,default:()=>["onChange","onRemove"]},rules:{type:Array},hideList:{type:Boolean,default:!1},onBeforeFilter:c(),onBeforeRead:c(),onAfterRead:c(),onBeforeRemove:c(),onRemove:c(),onOversize:c(),"onUpdate:modelValue":c()},{n:je,classes:qe}=Fe("uploader");let Ke=0;const Qe=Ue({name:"VarUploader",directives:{Ripple:$e,Hover:Ce},components:{VarIcon:Be,VarPopup:ke,VarFormDetails:Re,VarHoverOverlay:we},props:We,setup(e){const u=z(null),B=z(!1),k=z(null),E=J(()=>{const{maxlength:a,modelValue:{length:o}}=e;return He(a)?`${o} / ${a}`:""}),{form:s,bindForm:$}=Pe(),{errorMessage:F,validateWithTrigger:U,validate:H,resetValidation:g}=Se(),{hovering:L,handleHovering:l}=Ve(),y=J(()=>{const{modelValue:a,hideList:o}=e;return o?[]:a}),re=a=>{const{disabled:o,readonly:r,previewed:t}=e;if(s!=null&&s.disabled.value||s!=null&&s.readonly.value||o||r||!t)return;const{url:d}=a;if(Y(d)&&oe(d)){G(d);return}Y(d)&&se(d)&&(k.value=a,B.value=!0)},ne=a=>({id:Ke++,url:"",cover:"",name:a.name,file:a,progress:0}),te=a=>{const o=a.target,{files:r}=o;return Array.from(r)},ie=a=>new Promise(o=>{if(!a.file.type.startsWith("image")){o(a);return}const r=new FileReader;r.onload=()=>{const t=r.result;a.cover=t,a.url=t,o(a)},r.readAsDataURL(a.file)}),de=a=>a.map(ie),ue=a=>{const{onBeforeRead:o}=e;return a.map(r=>new Promise(t=>{o||t({valid:!0,varFile:r});const d=M(v(o,V(r)));Promise.all(d).then(b=>{t({valid:b.every(Boolean),varFile:r})})}))},me=async a=>{const{maxsize:o,maxlength:r,modelValue:t,onOversize:d,onAfterRead:b,onBeforeFilter:C,readonly:w,disabled:T}=e;if(s!=null&&s.disabled.value||s!=null&&s.readonly.value||T||w)return;const fe=n=>n.filter(h=>h.file.size>A(o)?(v(d,V(h)),!1):!0),ge=n=>{const h=Math.min(n.length,A(r)-t.length);return n.slice(0,h)},ye=async n=>{if(!C)return n;const h=M(C);for(const be of h)n=await be(n);return n};let m=te(a).map(ne);m=await ye(m),m=o!=null?fe(m):m,m=r!=null?ge(m):m;const he=await Promise.all(de(m)),Z=(await Promise.all(ue(he))).filter(({valid:n})=>n).map(({varFile:n})=>n);v(e["onUpdate:modelValue"],[...t,...Z]),a.target.value="",Z.forEach(n=>v(b,V(n)))},ve=async a=>{const{disabled:o,readonly:r,modelValue:t,onBeforeRemove:d,onRemove:b}=e;if(s!=null&&s.disabled.value||s!=null&&s.readonly.value||o||r)return;if(d){const w=M(v(d,V(a)));if((await Promise.all(w)).some(T=>!T))return}const C=t.filter(w=>w!==a);v(b,V(a)),K("onRemove"),v(e["onUpdate:modelValue"],C)},I=()=>e.modelValue.filter(a=>a.state==="success"),W=()=>e.modelValue.filter(a=>a.state==="error"),j=()=>e.modelValue.filter(a=>a.state==="loading"),ce=()=>{u.value.click()},pe=()=>{k.value=null,B.value=!1,G.close()},q={getSuccess:I,getError:W,getLoading:j},K=a=>{Ne(()=>{const{validateTrigger:o,rules:r,modelValue:t}=e;U(o,a,r,t,q)})};let N=!1;const Q=()=>H(e.rules,e.modelValue,q),X=()=>{N=!0,v(e["onUpdate:modelValue"],[]),g()};return v($,{validate:Q,resetValidation:g,reset:X}),Le(()=>e.modelValue,()=>{!N&&K("onChange"),N=!1},{deep:!0}),{n:je,classes:qe,formatElevation:De,input:u,files:y,showPreview:B,currentPreview:k,errorMessage:F,maxlengthText:E,hovering:L,formDisabled:s==null?void 0:s.disabled,formReadonly:s==null?void 0:s.readonly,toNumber:A,handleHovering:l,isHTMLSupportVideo:se,isHTMLSupportImage:oe,preview:re,handleChange:me,handleRemove:ve,getSuccess:I,getError:W,getLoading:j,validate:Q,resetValidation:g,reset:X,chooseFile:ce,closePreview:pe,toSizeUnit:Ie}}});const Xe=["onClick"],Ze=["onClick"],Ge=["src","alt"],Je=["multiple","accept","capture","disabled"],Ye=["src"];function _e(e,u,B,k,E,s){const $=S("var-icon"),F=S("var-hover-overlay"),U=S("var-form-details"),H=S("var-popup"),g=_("ripple"),L=_("hover");return p(),f("div",{class:i(e.classes(e.n(),e.n("$--box")))},[R("div",{class:i(e.n("file-list"))},[(p(!0),f(ze,null,Ae(e.files,l=>x((p(),f("div",{class:i(e.classes(e.n("file"),e.formatElevation(e.elevation,2),[l.state==="loading",e.n("--loading")])),key:l.id,onClick:y=>e.preview(l)},[R("div",{class:i(e.n("file-name"))},Me(l.name||l.url),3),e.removable?(p(),f("div",{key:0,class:i(e.n("file-close")),onClick:Oe(y=>e.handleRemove(l),["stop"])},[P($,{class:i(e.n("file-close-icon")),"var-uploader-cover":"",name:"delete"},null,8,["class"])],10,Ze)):D("",!0),l.cover?(p(),f("img",{key:1,class:i(e.n("file-cover")),style:ee({objectFit:l.fit}),src:l.cover,alt:l.name},null,14,Ge)):D("",!0),R("div",{class:i(e.n("file-indicator"))},[R("div",{class:i(e.classes(e.n("progress"),[l.state==="success",e.n("--success")],[l.state==="error",e.n("--error")])),style:ee({width:l.state==="success"||l.state==="error"?"100%":`${l.progress}%`})},null,6)],2)],10,Xe)),[[g,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple}]])),128)),!e.maxlength||e.modelValue.length<e.toNumber(e.maxlength)?x((p(),f("div",{key:0,class:i(e.classes([!e.$slots.default,`${e.n("action")} ${e.formatElevation(e.elevation,2)}`],[e.disabled||e.formDisabled,e.n("--disabled")])),onClick:u[1]||(u[1]=(...l)=>e.chooseFile&&e.chooseFile(...l))},[R("input",{ref:"input",type:"file",class:i(e.n("action-input")),multiple:e.multiple,accept:e.accept,capture:e.capture,disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly,onChange:u[0]||(u[0]=(...l)=>e.handleChange&&e.handleChange(...l))},null,42,Je),ae(e.$slots,"default",{},()=>[P($,{class:i(e.n("action-icon")),"var-uploader-cover":"",name:"plus"},null,8,["class"]),P(F,{hovering:e.hovering&&!e.disabled&&!e.formDisabled},null,8,["hovering"])])],2)),[[g,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple||e.$slots.default}],[L,e.handleHovering,"desktop"]]):D("",!0)],2),P(U,{"error-message":e.errorMessage,"extra-message":e.maxlengthText},Ee({_:2},[e.$slots["extra-message"]?{name:"extra-message",fn:le(()=>[ae(e.$slots,"extra-message")]),key:"0"}:void 0]),1032,["error-message","extra-message"]),P(H,{class:i(e.n("preview")),"var-uploader-cover":"",position:"center",show:e.showPreview,"onUpdate:show":u[2]||(u[2]=l=>e.showPreview=l),onClosed:u[3]||(u[3]=l=>e.currentPreview=null)},{default:le(()=>{var l,y;return[e.currentPreview&&e.isHTMLSupportVideo((l=e.currentPreview)==null?void 0:l.url)?(p(),f("video",{key:0,class:i(e.n("preview-video")),playsinline:"true","webkit-playsinline":"true","x5-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"false",controls:"",src:(y=e.currentPreview)==null?void 0:y.url},null,10,Ye)):D("",!0)]}),_:1},8,["class","show"])],2)}const O=Te(Qe,[["render",_e]]);O.install=function(e){e.component(O.name,O)};export{O as U};
