import{H as we,u as be}from"./index-9e4f0860.js";import{F as Ve,u as Re}from"./provide-15b7f3fc.js";import{I as Pe}from"./index-1bb8087a.js";import{P as Be}from"./index-3cef9030.js";import{I as J}from"./index-707fd254.js";import{v as $e}from"./index-5e24db38.js";import{v as ke}from"./index-4eca121b.js";import{d as v,h as Ce,a as m,f as Se,c as Le,w as De}from"./components-a440a044.js";import{d as Fe,r as z,B as X,ae as He,F as Ne,a4 as A,ac as Y,W as V,aQ as M,n as Te,_ as Ue,b as S,K as Z,e as c,l as p,m as R,M as ze,N as Ae,O as _,t as i,Q as Me,L as Ie,p as P,q as L,v as x,s as ee,aL as Ee,w as ae}from"./index-bf3396a3.js";import{i as oe,a as re}from"./shared-7db15b44.js";import{a as Oe}from"./elements-d23d7f14.js";const We={modelValue:{type:Array,default:()=>[]},accept:{type:String,default:"image/*"},capture:{type:[String,Boolean],default:void 0},multiple:Boolean,readonly:Boolean,disabled:Boolean,elevation:{type:[Boolean,Number,String],default:!0},removable:{type:Boolean,default:!0},maxlength:[Number,String],maxsize:[Number,String],previewed:{type:Boolean,default:!0},ripple:{type:Boolean,default:!0},validateTrigger:{type:Array,default:()=>["onChange","onRemove"]},rules:Array,hideList:Boolean,onBeforeFilter:v(),onBeforeRead:v(),onAfterRead:v(),onBeforeRemove:v(),onRemove:v(),onOversize:v(),"onUpdate:modelValue":v()},{name:Qe,n:je,classes:qe}=Le("uploader");let Ke=0;const Ge=Fe({name:Qe,directives:{Ripple:$e,Hover:ke},components:{VarIcon:Pe,VarPopup:Be,VarFormDetails:Ve,VarHoverOverlay:we},props:We,setup(e){const d=z(null),B=z(!1),$=z(null),I=X(()=>{const{maxlength:a,modelValue:{length:l}}=e;return He(a)?`${l} / ${a}`:""}),{form:r,bindForm:k}=Re(),{errorMessage:D,validateWithTrigger:F,validate:H,resetValidation:f}=Ce(),{hovering:N,handleHovering:o}=be(),g=X(()=>{const{modelValue:a,hideList:l}=e;return l?[]:a});let T=!1;const E={getSuccess:O,getError:W,getLoading:Q};m(k,{validate:q,resetValidation:f,reset:K}),Ne(()=>e.modelValue,()=>{!T&&j("onChange"),T=!1},{deep:!0});function le(a){const{disabled:l,previewed:s}=e;if(r!=null&&r.disabled.value||l||!s)return;const{url:n}=a;if(Y(n)&&re(n)){J(n);return}Y(n)&&oe(n)&&($.value=a,B.value=!0)}function se(a){return{id:Ke++,url:"",cover:"",name:a.name,file:a,progress:0}}function ne(a){const l=a.target,{files:s}=l;return Array.from(s)}function te(a){return new Promise(l=>{if(!a.file.type.startsWith("image")){l(a);return}const s=new FileReader;s.onload=()=>{const n=s.result;a.cover=n,a.url=n,l(a)},s.readAsDataURL(a.file)})}function ie(a){return a.map(te)}function de(a){const{onBeforeRead:l}=e;return a.map(s=>new Promise(n=>{l||n({valid:!0,varFile:s});const h=M(m(l,V(s)));Promise.all(h).then(w=>{n({valid:w.every(Boolean),varFile:s})})}))}async function ue(a){const{maxsize:l,maxlength:s,modelValue:n,onOversize:h,onAfterRead:w,onBeforeFilter:C,readonly:b,disabled:U}=e;if(r!=null&&r.disabled.value||r!=null&&r.readonly.value||U||b)return;const pe=t=>t.filter(y=>y.file.size>A(l)?(m(h,V(y)),!1):!0),fe=t=>{const y=Math.min(t.length,A(s)-n.length);return t.slice(0,y)},ge=async t=>{if(!C)return t;const y=M(C);for(const ye of y)t=await ye(t);return t};let u=ne(a).map(se);u=await ge(u),u=l!=null?pe(u):u,u=s!=null?fe(u):u;const he=await Promise.all(ie(u)),G=(await Promise.all(de(he))).filter(({valid:t})=>t).map(({varFile:t})=>t);m(e["onUpdate:modelValue"],[...n,...G]),a.target.value="",G.forEach(t=>m(w,V(t)))}async function me(a){const{disabled:l,readonly:s,modelValue:n,onBeforeRemove:h,onRemove:w}=e;if(r!=null&&r.disabled.value||r!=null&&r.readonly.value||l||s)return;if(h){const b=M(m(h,V(a)));if((await Promise.all(b)).some(U=>!U))return}const C=n.filter(b=>b!==a);m(w,V(a)),j("onRemove"),m(e["onUpdate:modelValue"],C)}function O(){return e.modelValue.filter(a=>a.state==="success")}function W(){return e.modelValue.filter(a=>a.state==="error")}function Q(){return e.modelValue.filter(a=>a.state==="loading")}function ve(){d.value.click()}function ce(){$.value=null,B.value=!1,J.close()}function j(a){Te(()=>{const{validateTrigger:l,rules:s,modelValue:n}=e;F(l,a,s,n,E)})}function q(){return H(e.rules,e.modelValue,E)}function K(){T=!0,m(e["onUpdate:modelValue"],[]),f()}return{input:d,files:g,showPreview:B,currentPreview:$,errorMessage:D,maxlengthText:I,hovering:N,formDisabled:r==null?void 0:r.disabled,formReadonly:r==null?void 0:r.readonly,n:je,classes:qe,formatElevation:Se,toNumber:A,handleHovering:o,isHTMLSupportVideo:oe,isHTMLSupportImage:re,preview:le,handleChange:ue,handleRemove:me,getSuccess:O,getError:W,getLoading:Q,validate:q,resetValidation:f,reset:K,chooseFile:ve,closePreview:ce,toSizeUnit:Oe}}});const Je=["onClick"],Xe=["onClick"],Ye=["src","alt"],Ze=["multiple","accept","capture","disabled"],_e=["src"];function xe(e,d,B,$,I,r){const k=S("var-icon"),D=S("var-hover-overlay"),F=S("var-form-details"),H=S("var-popup"),f=Z("ripple"),N=Z("hover");return c(),p("div",{class:i(e.classes(e.n(),e.n("$--box")))},[R("div",{class:i(e.n("file-list"))},[(c(!0),p(ze,null,Ae(e.files,o=>_((c(),p("div",{class:i(e.classes(e.n("file"),e.formatElevation(e.elevation,2),[o.state==="loading",e.n("--loading")])),key:o.id,onClick:g=>e.preview(o)},[R("div",{class:i(e.n("file-name"))},Me(o.name||o.url),3),e.removable?(c(),p("div",{key:0,class:i(e.n("file-close")),onClick:Ie(g=>e.handleRemove(o),["stop"])},[P(k,{class:i(e.n("file-close-icon")),"var-uploader-cover":"",name:"delete"},null,8,["class"])],10,Xe)):L("",!0),o.cover?(c(),p("img",{key:1,class:i(e.n("file-cover")),style:x({objectFit:o.fit}),src:o.cover,alt:o.name},null,14,Ye)):L("",!0),R("div",{class:i(e.n("file-indicator"))},[R("div",{class:i(e.classes(e.n("progress"),[o.state==="success",e.n("--success")],[o.state==="error",e.n("--error")])),style:x({width:o.state==="success"||o.state==="error"?"100%":`${o.progress}%`})},null,6)],2)],10,Je)),[[f,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple}]])),128)),!e.maxlength||e.modelValue.length<e.toNumber(e.maxlength)?_((c(),p("div",{key:0,class:i(e.classes([!e.$slots.default,`${e.n("action")} ${e.formatElevation(e.elevation,2)}`],[e.disabled||e.formDisabled,e.n("--disabled")])),onClick:d[1]||(d[1]=(...o)=>e.chooseFile&&e.chooseFile(...o))},[R("input",{ref:"input",type:"file",class:i(e.n("action-input")),multiple:e.multiple,accept:e.accept,capture:e.capture,disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly,onChange:d[0]||(d[0]=(...o)=>e.handleChange&&e.handleChange(...o))},null,42,Ze),ee(e.$slots,"default",{},()=>[P(k,{class:i(e.n("action-icon")),"var-uploader-cover":"",name:"plus"},null,8,["class"]),P(D,{hovering:e.hovering&&!e.disabled&&!e.formDisabled},null,8,["hovering"])])],2)),[[f,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple||e.$slots.default}],[N,e.handleHovering,"desktop"]]):L("",!0)],2),P(F,{"error-message":e.errorMessage,"extra-message":e.maxlengthText},Ee({_:2},[e.$slots["extra-message"]?{name:"extra-message",fn:ae(()=>[ee(e.$slots,"extra-message")]),key:"0"}:void 0]),1032,["error-message","extra-message"]),P(H,{class:i(e.n("preview")),"var-uploader-cover":"",position:"center",show:e.showPreview,"onUpdate:show":d[2]||(d[2]=o=>e.showPreview=o),onClosed:d[3]||(d[3]=o=>e.currentPreview=null)},{default:ae(()=>{var o,g;return[e.currentPreview&&e.isHTMLSupportVideo((o=e.currentPreview)==null?void 0:o.url)?(c(),p("video",{key:0,class:i(e.n("preview-video")),playsinline:"true","webkit-playsinline":"true","x5-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"false",controls:"",src:(g=e.currentPreview)==null?void 0:g.url},null,10,_e)):L("",!0)]}),_:1},8,["class","show"])],2)}const ea=Ue(Ge,[["render",xe]]);De(ea);export{ea as U};
