import{H as pe,u as fe}from"./index-34c73e6b.js";import{F as ge,u as ye}from"./provide-2d8aed18.js";import{I as he}from"./index-84639265.js";import{P as be}from"./index-4bfd8da8.js";import{I as Z}from"./index-111d2114.js";import{v as Ve}from"./index-4453413c.js";import{v as we}from"./index-d73f18e4.js";import{d as h,i as Re,a as m,c as Pe}from"./components-440543a7.js";import{d as Ce,a as z,b as G,X as $e,w as ke,W as J,r as w,n as Be,Z as K,ax as Y,_ as Se,p as B,ag as _,f as p,h as f,M as S,F as De,ai as Fe,D as x,N as i,Q as He,ah as Le,q as R,j as D,R as Ue,O as Te,S as Ne}from"./vue-router.esm-bundler-6be07501.js";import{i as ee,a as ae}from"./shared-bf7e5160.js";const ze={modelValue:{type:Array,default:()=>[]},accept:{type:String,default:"image/*"},capture:{type:[String,Boolean],default:void 0},multiple:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},removable:{type:Boolean,default:!0},maxlength:{type:[Number,String]},maxsize:{type:[Number,String]},previewed:{type:Boolean,default:!0},ripple:{type:Boolean,default:!0},validateTrigger:{type:Array,default:()=>["onChange","onRemove"]},rules:{type:Array},hideList:{type:Boolean,default:!1},onBeforeRead:h(),onAfterRead:h(),onBeforeRemove:h(),onRemove:h(),onOversize:h(),"onUpdate:modelValue":h()},{n:Ae,classes:Me}=Pe("uploader");let Ie=0;const Oe=Ce({name:"VarUploader",directives:{Ripple:Ve,Hover:we},components:{VarIcon:he,VarPopup:be,VarFormDetails:ge,VarHoverOverlay:pe},props:ze,setup(e){const d=z(null),P=z(!1),C=z(null),M=G(()=>{const{maxlength:a,modelValue:{length:o}}=e;return $e(a)?`${o} / ${a}`:""}),{form:l,bindForm:$}=ye(),{errorMessage:F,validateWithTrigger:H,validate:L,resetValidation:g}=Re(),{hovering:U,handleHovering:s}=fe(),y=G(()=>{const{modelValue:a,hideList:o}=e;return o?[]:a}),le=a=>{const{disabled:o,readonly:r,previewed:t}=e;if(l!=null&&l.disabled.value||l!=null&&l.readonly.value||o||r||!t)return;const{url:n}=a;if(J(n)&&ae(n)){Z(n);return}J(n)&&ee(n)&&(C.value=a,P.value=!0)},se=a=>({id:Ie++,url:"",cover:"",name:a.name,file:a}),oe=a=>{const o=a.target,{files:r}=o;return Array.from(r)},re=a=>new Promise(o=>{const r=new FileReader;r.onload=()=>{const t=r.result;a.file.type.startsWith("image")&&(a.cover=t),a.url=t,o(a)},r.readAsDataURL(a.file)}),ne=a=>a.map(re),te=a=>{const{onBeforeRead:o}=e;return a.map(r=>new Promise(t=>{o||t({valid:!0,varFile:r});let n=m(o,w(r));n=Y(n)?n:[n],Promise.all(n).then(b=>{t({valid:!b.some(V=>!V),varFile:r})})}))},ie=async a=>{const{maxsize:o,maxlength:r,modelValue:t,onOversize:n,onAfterRead:b,readonly:V,disabled:v}=e;if(l!=null&&l.disabled.value||l!=null&&l.readonly.value||v||V)return;const N=u=>u.filter(k=>k.file.size>K(o)?(m(n,w(k)),!1):!0),me=u=>{const k=Math.min(u.length,K(r)-t.length);return u.slice(0,k)};let c=oe(a).map(se);c=o!=null?N(c):c,c=r!=null?me(c):c;const ce=await Promise.all(ne(c)),X=(await Promise.all(te(ce))).filter(({valid:u})=>u).map(({varFile:u})=>u);m(e["onUpdate:modelValue"],[...t,...X]),a.target.value="",X.forEach(u=>m(b,w(u)))},de=async a=>{const{disabled:o,readonly:r,modelValue:t,onBeforeRemove:n,onRemove:b}=e;if(l!=null&&l.disabled.value||l!=null&&l.readonly.value||o||r)return;if(n){let v=m(n,w(a));if(v=Y(v)?v:[v],(await Promise.all(v)).some(N=>!N))return}const V=t.filter(v=>v!==a);m(b,w(a)),j("onRemove"),m(e["onUpdate:modelValue"],V)},I=()=>e.modelValue.filter(a=>a.state==="success"),O=()=>e.modelValue.filter(a=>a.state==="error"),W=()=>e.modelValue.filter(a=>a.state==="loading"),ue=()=>{d.value.click()},ve=()=>{C.value=null,P.value=!1,Z.close()},E={getSuccess:I,getError:O,getLoading:W},j=a=>{Be(()=>{const{validateTrigger:o,rules:r,modelValue:t}=e;H(o,a,r,t,E)})};let T=!1;const q=()=>L(e.rules,e.modelValue,E),Q=()=>{T=!0,m(e["onUpdate:modelValue"],[]),g()};return m($,{validate:q,resetValidation:g,reset:Q}),ke(()=>e.modelValue,()=>{!T&&j("onChange"),T=!1},{deep:!0}),{n:Ae,classes:Me,input:d,files:y,showPreview:P,currentPreview:C,errorMessage:F,maxlengthText:M,hovering:U,formDisabled:l==null?void 0:l.disabled,formReadonly:l==null?void 0:l.readonly,handleHovering:s,isHTMLSupportVideo:ee,isHTMLSupportImage:ae,preview:le,handleChange:ie,handleRemove:de,getSuccess:I,getError:O,getLoading:W,validate:q,resetValidation:g,reset:Q,chooseFile:ue,closePreview:ve}}});const We=["onClick"],Ee=["onClick"],je=["src","alt"],qe=["multiple","accept","capture","disabled"],Qe=["src"];function Xe(e,d,P,C,M,l){const $=B("var-icon"),F=B("var-hover-overlay"),H=B("var-form-details"),L=B("var-popup"),g=_("ripple"),U=_("hover");return p(),f("div",{class:i(e.classes(e.n(),e.n("$--box")))},[S("div",{class:i(e.n("file-list"))},[(p(!0),f(De,null,Fe(e.files,s=>x((p(),f("div",{class:i(e.classes(e.n("file"),e.n("$-elevation--2"),[s.state==="loading",e.n("--loading")])),key:s.id,onClick:y=>e.preview(s)},[S("div",{class:i(e.n("file-name"))},He(s.name||s.url),3),e.removable?(p(),f("div",{key:0,class:i(e.n("file-close")),onClick:Le(y=>e.handleRemove(s),["stop"])},[R($,{class:i(e.n("file-close-icon")),"var-uploader-cover":"",name:"delete"},null,8,["class"])],10,Ee)):D("",!0),s.cover?(p(),f("img",{key:1,class:i(e.n("file-cover")),style:Ue({objectFit:s.fit}),src:s.cover,alt:s.name},null,14,je)):D("",!0),S("div",{class:i(e.classes(e.n("file-indicator"),[s.state==="success",e.n("--success")],[s.state==="error",e.n("--error")]))},null,2)],10,We)),[[g,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple}]])),128)),!e.maxlength||e.modelValue.length<e.maxlength?x((p(),f("div",{key:0,class:i(e.classes([!e.$slots.default,`${e.n("action")} ${e.n("$-elevation--2")}`],[e.disabled||e.formDisabled,e.n("--disabled")])),onClick:d[1]||(d[1]=(...s)=>e.chooseFile&&e.chooseFile(...s))},[S("input",{ref:"input",type:"file",class:i(e.n("action-input")),multiple:e.multiple,accept:e.accept,capture:e.capture,disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly,onChange:d[0]||(d[0]=(...s)=>e.handleChange&&e.handleChange(...s))},null,42,qe),Te(e.$slots,"default",{},()=>[R($,{class:i(e.n("action-icon")),"var-uploader-cover":"",name:"plus"},null,8,["class"]),R(F,{hovering:e.hovering&&!e.disabled&&!e.formDisabled},null,8,["hovering"])])],2)),[[g,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple||e.$slots.default}],[U,e.handleHovering,"desktop"]]):D("",!0)],2),R(H,{"error-message":e.errorMessage,"extra-message":e.maxlengthText},null,8,["error-message","extra-message"]),R(L,{class:i(e.n("preview")),"var-uploader-cover":"",position:"center",show:e.showPreview,"onUpdate:show":d[2]||(d[2]=s=>e.showPreview=s),onClosed:d[3]||(d[3]=s=>e.currentPreview=null)},{default:Ne(()=>{var s,y;return[e.currentPreview&&e.isHTMLSupportVideo((s=e.currentPreview)==null?void 0:s.url)?(p(),f("video",{key:0,class:i(e.n("preview-video")),playsinline:"true","webkit-playsinline":"true","x5-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"false",controls:"",src:(y=e.currentPreview)==null?void 0:y.url},null,10,Qe)):D("",!0)]}),_:1},8,["class","show"])],2)}const A=Se(Oe,[["render",Xe]]);A.install=function(e){e.component(A.name,A)};export{A as U};
