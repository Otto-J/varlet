import{H as we,u as be}from"./index-7363fea8.js";import{F as Ve,u as Re}from"./provide-a5f44665.js";import{I as Pe}from"./index-7744b9fd.js";import{P as Be}from"./index-d4861dfa.js";import{I as G}from"./index-0206e553.js";import{v as $e}from"./index-97ca1416.js";import{v as ke}from"./index-0ce9506e.js";import{d as c,j as Ce,a as v,f as Se,c as De,w as Fe}from"./components-cb0b140b.js";import{d as Te,a as z,b as J,X as Ue,w as He,Z as A,W as K,r as V,aT as M,n as Le,_ as Ne,p as S,af as Y,f as p,h as f,M as R,F as ze,ah as Ae,D as _,N as i,Q as Me,ag as Ie,q as P,j as D,R as x,O as ee,aO as Oe,S as ae}from"./vue-router-1c193d5c.js";import{i as se,a as oe}from"./shared-14c7e7a7.js";import{a as Ee}from"./elements-feeb8461.js";const We={modelValue:{type:Array,default:()=>[]},accept:{type:String,default:"image/*"},capture:{type:[String,Boolean],default:void 0},multiple:Boolean,readonly:Boolean,disabled:Boolean,elevation:{type:[Boolean,Number,String],default:!0},removable:{type:Boolean,default:!0},maxlength:[Number,String],maxsize:[Number,String],previewed:{type:Boolean,default:!0},ripple:{type:Boolean,default:!0},validateTrigger:{type:Array,default:()=>["onChange","onRemove"]},rules:Array,hideList:Boolean,onBeforeFilter:c(),onBeforeRead:c(),onAfterRead:c(),onBeforeRemove:c(),onRemove:c(),onOversize:c(),"onUpdate:modelValue":c()},{n:je,classes:qe}=De("uploader");let Qe=0;const Xe=Te({name:"VarUploader",directives:{Ripple:$e,Hover:ke},components:{VarIcon:Pe,VarPopup:Be,VarFormDetails:Ve,VarHoverOverlay:we},props:We,setup(e){const u=z(null),B=z(!1),$=z(null),I=J(()=>{const{maxlength:a,modelValue:{length:l}}=e;return Ue(a)?`${l} / ${a}`:""}),{form:o,bindForm:k}=Re(),{errorMessage:F,validateWithTrigger:T,validate:U,resetValidation:g}=Ce(),{hovering:H,handleHovering:s}=be(),h=J(()=>{const{modelValue:a,hideList:l}=e;return l?[]:a}),le=a=>{const{disabled:l,readonly:r,previewed:t}=e;if(o!=null&&o.disabled.value||o!=null&&o.readonly.value||l||r||!t)return;const{url:d}=a;if(K(d)&&oe(d)){G(d);return}K(d)&&se(d)&&($.value=a,B.value=!0)},re=a=>({id:Qe++,url:"",cover:"",name:a.name,file:a,progress:0}),ne=a=>{const l=a.target,{files:r}=l;return Array.from(r)},te=a=>new Promise(l=>{if(!a.file.type.startsWith("image")){l(a);return}const r=new FileReader;r.onload=()=>{const t=r.result;a.cover=t,a.url=t,l(a)},r.readAsDataURL(a.file)}),ie=a=>a.map(te),de=a=>{const{onBeforeRead:l}=e;return a.map(r=>new Promise(t=>{l||t({valid:!0,varFile:r});const d=M(v(l,V(r)));Promise.all(d).then(w=>{t({valid:w.every(Boolean),varFile:r})})}))},ue=async a=>{const{maxsize:l,maxlength:r,modelValue:t,onOversize:d,onAfterRead:w,onBeforeFilter:C,readonly:b,disabled:N}=e;if(o!=null&&o.disabled.value||o!=null&&o.readonly.value||N||b)return;const pe=n=>n.filter(y=>y.file.size>A(l)?(v(d,V(y)),!1):!0),fe=n=>{const y=Math.min(n.length,A(r)-t.length);return n.slice(0,y)},ge=async n=>{if(!C)return n;const y=M(C);for(const ye of y)n=await ye(n);return n};let m=ne(a).map(re);m=await ge(m),m=l!=null?pe(m):m,m=r!=null?fe(m):m;const he=await Promise.all(ie(m)),Z=(await Promise.all(de(he))).filter(({valid:n})=>n).map(({varFile:n})=>n);v(e["onUpdate:modelValue"],[...t,...Z]),a.target.value="",Z.forEach(n=>v(w,V(n)))},me=async a=>{const{disabled:l,readonly:r,modelValue:t,onBeforeRemove:d,onRemove:w}=e;if(o!=null&&o.disabled.value||o!=null&&o.readonly.value||l||r)return;if(d){const b=M(v(d,V(a)));if((await Promise.all(b)).some(N=>!N))return}const C=t.filter(b=>b!==a);v(w,V(a)),q("onRemove"),v(e["onUpdate:modelValue"],C)},O=()=>e.modelValue.filter(a=>a.state==="success"),E=()=>e.modelValue.filter(a=>a.state==="error"),W=()=>e.modelValue.filter(a=>a.state==="loading"),ve=()=>{u.value.click()},ce=()=>{$.value=null,B.value=!1,G.close()},j={getSuccess:O,getError:E,getLoading:W},q=a=>{Le(()=>{const{validateTrigger:l,rules:r,modelValue:t}=e;T(l,a,r,t,j)})};let L=!1;const Q=()=>U(e.rules,e.modelValue,j),X=()=>{L=!0,v(e["onUpdate:modelValue"],[]),g()};return v(k,{validate:Q,resetValidation:g,reset:X}),He(()=>e.modelValue,()=>{!L&&q("onChange"),L=!1},{deep:!0}),{n:je,classes:qe,formatElevation:Se,input:u,files:h,showPreview:B,currentPreview:$,errorMessage:F,maxlengthText:I,hovering:H,formDisabled:o==null?void 0:o.disabled,formReadonly:o==null?void 0:o.readonly,toNumber:A,handleHovering:s,isHTMLSupportVideo:se,isHTMLSupportImage:oe,preview:le,handleChange:ue,handleRemove:me,getSuccess:O,getError:E,getLoading:W,validate:Q,resetValidation:g,reset:X,chooseFile:ve,closePreview:ce,toSizeUnit:Ee}}});const Ze=["onClick"],Ge=["onClick"],Je=["src","alt"],Ke=["multiple","accept","capture","disabled"],Ye=["src"];function _e(e,u,B,$,I,o){const k=S("var-icon"),F=S("var-hover-overlay"),T=S("var-form-details"),U=S("var-popup"),g=Y("ripple"),H=Y("hover");return p(),f("div",{class:i(e.classes(e.n(),e.n("$--box")))},[R("div",{class:i(e.n("file-list"))},[(p(!0),f(ze,null,Ae(e.files,s=>_((p(),f("div",{class:i(e.classes(e.n("file"),e.formatElevation(e.elevation,2),[s.state==="loading",e.n("--loading")])),key:s.id,onClick:h=>e.preview(s)},[R("div",{class:i(e.n("file-name"))},Me(s.name||s.url),3),e.removable?(p(),f("div",{key:0,class:i(e.n("file-close")),onClick:Ie(h=>e.handleRemove(s),["stop"])},[P(k,{class:i(e.n("file-close-icon")),"var-uploader-cover":"",name:"delete"},null,8,["class"])],10,Ge)):D("",!0),s.cover?(p(),f("img",{key:1,class:i(e.n("file-cover")),style:x({objectFit:s.fit}),src:s.cover,alt:s.name},null,14,Je)):D("",!0),R("div",{class:i(e.n("file-indicator"))},[R("div",{class:i(e.classes(e.n("progress"),[s.state==="success",e.n("--success")],[s.state==="error",e.n("--error")])),style:x({width:s.state==="success"||s.state==="error"?"100%":`${s.progress}%`})},null,6)],2)],10,Ze)),[[g,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple}]])),128)),!e.maxlength||e.modelValue.length<e.toNumber(e.maxlength)?_((p(),f("div",{key:0,class:i(e.classes([!e.$slots.default,`${e.n("action")} ${e.formatElevation(e.elevation,2)}`],[e.disabled||e.formDisabled,e.n("--disabled")])),onClick:u[1]||(u[1]=(...s)=>e.chooseFile&&e.chooseFile(...s))},[R("input",{ref:"input",type:"file",class:i(e.n("action-input")),multiple:e.multiple,accept:e.accept,capture:e.capture,disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly,onChange:u[0]||(u[0]=(...s)=>e.handleChange&&e.handleChange(...s))},null,42,Ke),ee(e.$slots,"default",{},()=>[P(k,{class:i(e.n("action-icon")),"var-uploader-cover":"",name:"plus"},null,8,["class"]),P(F,{hovering:e.hovering&&!e.disabled&&!e.formDisabled},null,8,["hovering"])])],2)),[[g,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple||e.$slots.default}],[H,e.handleHovering,"desktop"]]):D("",!0)],2),P(T,{"error-message":e.errorMessage,"extra-message":e.maxlengthText},Oe({_:2},[e.$slots["extra-message"]?{name:"extra-message",fn:ae(()=>[ee(e.$slots,"extra-message")]),key:"0"}:void 0]),1032,["error-message","extra-message"]),P(U,{class:i(e.n("preview")),"var-uploader-cover":"",position:"center",show:e.showPreview,"onUpdate:show":u[2]||(u[2]=s=>e.showPreview=s),onClosed:u[3]||(u[3]=s=>e.currentPreview=null)},{default:ae(()=>{var s,h;return[e.currentPreview&&e.isHTMLSupportVideo((s=e.currentPreview)==null?void 0:s.url)?(p(),f("video",{key:0,class:i(e.n("preview-video")),playsinline:"true","webkit-playsinline":"true","x5-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"false",controls:"",src:(h=e.currentPreview)==null?void 0:h.url},null,10,Ye)):D("",!0)]}),_:1},8,["class","show"])],2)}const xe=Ne(Xe,[["render",_e]]);Fe(xe);export{xe as U};
