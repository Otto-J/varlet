import{H as ce,u as fe}from"./index-53ab5584.js";import{F as ge,u as ye}from"./provide-b5779416.js";import{I as he}from"./index-a885f0cf.js";import{P as be}from"./index-c592eda4.js";import{I as Z}from"./index-9d14aee0.js";import{v as Ve}from"./index-8483d209.js";import{v as we}from"./index-86495249.js";import{d as y,k as Re,a as v,f as Pe,c as Be}from"./components-81cb4df4.js";import{d as ke,a as z,b as G,w as Ce,X as Se,W as J,r as V,aM as K,n as $e,Z as Y,_ as De,p as C,ag as _,f as p,h as c,M as S,F as Fe,ai as He,D as x,N as t,Q as Le,ah as Te,q as w,j as $,R as Ue,O as Ne,S as ze}from"./vue-router-26f60498.js";import{i as ee,a as ae}from"./shared-aa506370.js";const Me={modelValue:{type:Array,default:()=>[]},accept:{type:String,default:"image/*"},capture:{type:[String,Boolean],default:void 0},multiple:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},elevation:{type:[Boolean,Number,String],default:!0},removable:{type:Boolean,default:!0},maxlength:{type:[Number,String]},maxsize:{type:[Number,String]},previewed:{type:Boolean,default:!0},ripple:{type:Boolean,default:!0},validateTrigger:{type:Array,default:()=>["onChange","onRemove"]},rules:{type:Array},hideList:{type:Boolean,default:!1},onBeforeRead:y(),onAfterRead:y(),onBeforeRemove:y(),onRemove:y(),onOversize:y(),"onUpdate:modelValue":y()},{n:Ae,classes:Ee}=Be("uploader");let Ie=0;const Oe=ke({name:"VarUploader",directives:{Ripple:Ve,Hover:we},components:{VarIcon:he,VarPopup:be,VarFormDetails:ge,VarHoverOverlay:ce},props:Me,setup(e){const d=z(null),R=z(!1),P=z(null),A=G(()=>{const{maxlength:a,modelValue:{length:s}}=e;return Se(a)?`${s} / ${a}`:""}),{form:l,bindForm:B}=ye(),{errorMessage:D,validateWithTrigger:F,validate:H,resetValidation:f}=Re(),{hovering:L,handleHovering:o}=fe(),g=G(()=>{const{modelValue:a,hideList:s}=e;return s?[]:a}),le=a=>{const{disabled:s,readonly:r,previewed:n}=e;if(l!=null&&l.disabled.value||l!=null&&l.readonly.value||s||r||!n)return;const{url:i}=a;if(J(i)&&ae(i)){Z(i);return}J(i)&&ee(i)&&(P.value=a,R.value=!0)},oe=a=>({id:Ie++,url:"",cover:"",name:a.name,file:a}),se=a=>{const s=a.target,{files:r}=s;return Array.from(r)},re=a=>new Promise(s=>{const r=new FileReader;r.onload=()=>{const n=r.result;a.file.type.startsWith("image")&&(a.cover=n),a.url=n,s(a)},r.readAsDataURL(a.file)}),ne=a=>a.map(re),te=a=>{const{onBeforeRead:s}=e;return a.map(r=>new Promise(n=>{s||n({valid:!0,varFile:r});const i=K(v(s,V(r)));Promise.all(i).then(h=>{n({valid:h.every(Boolean),varFile:r})})}))},ie=async a=>{const{maxsize:s,maxlength:r,modelValue:n,onOversize:i,onAfterRead:h,readonly:U,disabled:b}=e;if(l!=null&&l.disabled.value||l!=null&&l.readonly.value||b||U)return;const N=u=>u.filter(k=>k.file.size>Y(s)?(v(i,V(k)),!1):!0),me=u=>{const k=Math.min(u.length,Y(r)-n.length);return u.slice(0,k)};let m=se(a).map(oe);m=s!=null?N(m):m,m=r!=null?me(m):m;const pe=await Promise.all(ne(m)),X=(await Promise.all(te(pe))).filter(({valid:u})=>u).map(({varFile:u})=>u);v(e["onUpdate:modelValue"],[...n,...X]),a.target.value="",X.forEach(u=>v(h,V(u)))},de=async a=>{const{disabled:s,readonly:r,modelValue:n,onBeforeRemove:i,onRemove:h}=e;if(l!=null&&l.disabled.value||l!=null&&l.readonly.value||s||r)return;if(i){const b=K(v(i,V(a)));if((await Promise.all(b)).some(N=>!N))return}const U=n.filter(b=>b!==a);v(h,V(a)),j("onRemove"),v(e["onUpdate:modelValue"],U)},E=()=>e.modelValue.filter(a=>a.state==="success"),I=()=>e.modelValue.filter(a=>a.state==="error"),O=()=>e.modelValue.filter(a=>a.state==="loading"),ue=()=>{d.value.click()},ve=()=>{P.value=null,R.value=!1,Z.close()},W={getSuccess:E,getError:I,getLoading:O},j=a=>{$e(()=>{const{validateTrigger:s,rules:r,modelValue:n}=e;F(s,a,r,n,W)})};let T=!1;const q=()=>H(e.rules,e.modelValue,W),Q=()=>{T=!0,v(e["onUpdate:modelValue"],[]),f()};return v(B,{validate:q,resetValidation:f,reset:Q}),Ce(()=>e.modelValue,()=>{!T&&j("onChange"),T=!1},{deep:!0}),{n:Ae,classes:Ee,formatElevation:Pe,input:d,files:g,showPreview:R,currentPreview:P,errorMessage:D,maxlengthText:A,hovering:L,formDisabled:l==null?void 0:l.disabled,formReadonly:l==null?void 0:l.readonly,handleHovering:o,isHTMLSupportVideo:ee,isHTMLSupportImage:ae,preview:le,handleChange:ie,handleRemove:de,getSuccess:E,getError:I,getLoading:O,validate:q,resetValidation:f,reset:Q,chooseFile:ue,closePreview:ve}}});const We=["onClick"],je=["onClick"],qe=["src","alt"],Qe=["multiple","accept","capture","disabled"],Xe=["src"];function Ze(e,d,R,P,A,l){const B=C("var-icon"),D=C("var-hover-overlay"),F=C("var-form-details"),H=C("var-popup"),f=_("ripple"),L=_("hover");return p(),c("div",{class:t(e.classes(e.n(),e.n("$--box")))},[S("div",{class:t(e.n("file-list"))},[(p(!0),c(Fe,null,He(e.files,o=>x((p(),c("div",{class:t(e.classes(e.n("file"),e.formatElevation(e.elevation,2),[o.state==="loading",e.n("--loading")])),key:o.id,onClick:g=>e.preview(o)},[S("div",{class:t(e.n("file-name"))},Le(o.name||o.url),3),e.removable?(p(),c("div",{key:0,class:t(e.n("file-close")),onClick:Te(g=>e.handleRemove(o),["stop"])},[w(B,{class:t(e.n("file-close-icon")),"var-uploader-cover":"",name:"delete"},null,8,["class"])],10,je)):$("",!0),o.cover?(p(),c("img",{key:1,class:t(e.n("file-cover")),style:Ue({objectFit:o.fit}),src:o.cover,alt:o.name},null,14,qe)):$("",!0),S("div",{class:t(e.classes(e.n("file-indicator"),[o.state==="success",e.n("--success")],[o.state==="error",e.n("--error")]))},null,2)],10,We)),[[f,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple}]])),128)),!e.maxlength||e.modelValue.length<e.maxlength?x((p(),c("div",{key:0,class:t(e.classes([!e.$slots.default,`${e.n("action")} ${e.formatElevation(e.elevation,2)}`],[e.disabled||e.formDisabled,e.n("--disabled")])),onClick:d[1]||(d[1]=(...o)=>e.chooseFile&&e.chooseFile(...o))},[S("input",{ref:"input",type:"file",class:t(e.n("action-input")),multiple:e.multiple,accept:e.accept,capture:e.capture,disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly,onChange:d[0]||(d[0]=(...o)=>e.handleChange&&e.handleChange(...o))},null,42,Qe),Ne(e.$slots,"default",{},()=>[w(B,{class:t(e.n("action-icon")),"var-uploader-cover":"",name:"plus"},null,8,["class"]),w(D,{hovering:e.hovering&&!e.disabled&&!e.formDisabled},null,8,["hovering"])])],2)),[[f,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple||e.$slots.default}],[L,e.handleHovering,"desktop"]]):$("",!0)],2),w(F,{"error-message":e.errorMessage,"extra-message":e.maxlengthText},null,8,["error-message","extra-message"]),w(H,{class:t(e.n("preview")),"var-uploader-cover":"",position:"center",show:e.showPreview,"onUpdate:show":d[2]||(d[2]=o=>e.showPreview=o),onClosed:d[3]||(d[3]=o=>e.currentPreview=null)},{default:ze(()=>{var o,g;return[e.currentPreview&&e.isHTMLSupportVideo((o=e.currentPreview)==null?void 0:o.url)?(p(),c("video",{key:0,class:t(e.n("preview-video")),playsinline:"true","webkit-playsinline":"true","x5-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"false",controls:"",src:(g=e.currentPreview)==null?void 0:g.url},null,10,Xe)):$("",!0)]}),_:1},8,["class","show"])],2)}const M=De(Oe,[["render",Ze]]);M.install=function(e){e.component(M.name,M)};export{M as U};
