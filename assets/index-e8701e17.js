import{H as fe,u as ge}from"./index-be681219.js";import{F as ye,u as he}from"./provide-978d8abc.js";import{I as be}from"./index-e04a03bb.js";import{P as we}from"./index-8aabf9e0.js";import{I as Z}from"./index-b305961b.js";import{v as Ve}from"./index-be51f060.js";import{v as Re}from"./index-d5bd510c.js";import{d as y,k as Pe,a as v,f as Be,c as ke}from"./components-7bcea1d6.js";import{d as Ce,a as z,b as G,X as Se,w as $e,W as J,r as w,aN as K,n as De,Z as Y,_ as Ue,p as S,ag as _,f as p,h as c,M as V,F as Fe,ai as He,D as x,N as t,Q as Le,ah as Ne,q as R,j as $,R as ee,O as Te,S as ze}from"./vue-router-609def63.js";import{i as ae,a as le}from"./shared-71dfa5a1.js";import{a as Ae}from"./elements-6a3d747f.js";const Me={modelValue:{type:Array,default:()=>[]},accept:{type:String,default:"image/*"},capture:{type:[String,Boolean],default:void 0},multiple:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},elevation:{type:[Boolean,Number,String],default:!0},removable:{type:Boolean,default:!0},maxlength:{type:[Number,String]},maxsize:{type:[Number,String]},previewed:{type:Boolean,default:!0},ripple:{type:Boolean,default:!0},validateTrigger:{type:Array,default:()=>["onChange","onRemove"]},rules:{type:Array},hideList:{type:Boolean,default:!1},onBeforeRead:y(),onAfterRead:y(),onBeforeRemove:y(),onRemove:y(),onOversize:y(),"onUpdate:modelValue":y()},{n:Ee,classes:Ie}=ke("uploader");let Oe=0;const We=Ce({name:"VarUploader",directives:{Ripple:Ve,Hover:Re},components:{VarIcon:be,VarPopup:we,VarFormDetails:ye,VarHoverOverlay:fe},props:Me,setup(e){const d=z(null),P=z(!1),B=z(null),M=G(()=>{const{maxlength:a,modelValue:{length:o}}=e;return Se(a)?`${o} / ${a}`:""}),{form:s,bindForm:k}=he(),{errorMessage:D,validateWithTrigger:U,validate:F,resetValidation:f}=Pe(),{hovering:H,handleHovering:l}=ge(),g=G(()=>{const{modelValue:a,hideList:o}=e;return o?[]:a}),se=a=>{const{disabled:o,readonly:r,previewed:n}=e;if(s!=null&&s.disabled.value||s!=null&&s.readonly.value||o||r||!n)return;const{url:i}=a;if(J(i)&&le(i)){Z(i);return}J(i)&&ae(i)&&(B.value=a,P.value=!0)},oe=a=>({id:Oe++,url:"",cover:"",name:a.name,file:a,progress:0}),re=a=>{const o=a.target,{files:r}=o;return Array.from(r)},ne=a=>new Promise(o=>{if(!a.file.type.startsWith("image")){o(a);return}const r=new FileReader;r.onload=()=>{const n=r.result;a.cover=n,a.url=n,o(a)},r.readAsDataURL(a.file)}),te=a=>a.map(ne),ie=a=>{const{onBeforeRead:o}=e;return a.map(r=>new Promise(n=>{o||n({valid:!0,varFile:r});const i=K(v(o,w(r)));Promise.all(i).then(h=>{n({valid:h.every(Boolean),varFile:r})})}))},de=async a=>{const{maxsize:o,maxlength:r,modelValue:n,onOversize:i,onAfterRead:h,readonly:N,disabled:b}=e;if(s!=null&&s.disabled.value||s!=null&&s.readonly.value||b||N)return;const T=u=>u.filter(C=>C.file.size>Y(o)?(v(i,w(C)),!1):!0),pe=u=>{const C=Math.min(u.length,Y(r)-n.length);return u.slice(0,C)};let m=re(a).map(oe);m=o!=null?T(m):m,m=r!=null?pe(m):m;const ce=await Promise.all(te(m)),X=(await Promise.all(ie(ce))).filter(({valid:u})=>u).map(({varFile:u})=>u);v(e["onUpdate:modelValue"],[...n,...X]),a.target.value="",X.forEach(u=>v(h,w(u)))},ue=async a=>{const{disabled:o,readonly:r,modelValue:n,onBeforeRemove:i,onRemove:h}=e;if(s!=null&&s.disabled.value||s!=null&&s.readonly.value||o||r)return;if(i){const b=K(v(i,w(a)));if((await Promise.all(b)).some(T=>!T))return}const N=n.filter(b=>b!==a);v(h,w(a)),j("onRemove"),v(e["onUpdate:modelValue"],N)},E=()=>e.modelValue.filter(a=>a.state==="success"),I=()=>e.modelValue.filter(a=>a.state==="error"),O=()=>e.modelValue.filter(a=>a.state==="loading"),ve=()=>{d.value.click()},me=()=>{B.value=null,P.value=!1,Z.close()},W={getSuccess:E,getError:I,getLoading:O},j=a=>{De(()=>{const{validateTrigger:o,rules:r,modelValue:n}=e;U(o,a,r,n,W)})};let L=!1;const q=()=>F(e.rules,e.modelValue,W),Q=()=>{L=!0,v(e["onUpdate:modelValue"],[]),f()};return v(k,{validate:q,resetValidation:f,reset:Q}),$e(()=>e.modelValue,()=>{!L&&j("onChange"),L=!1},{deep:!0}),{n:Ee,classes:Ie,formatElevation:Be,input:d,files:g,showPreview:P,currentPreview:B,errorMessage:D,maxlengthText:M,hovering:H,formDisabled:s==null?void 0:s.disabled,formReadonly:s==null?void 0:s.readonly,handleHovering:l,isHTMLSupportVideo:ae,isHTMLSupportImage:le,preview:se,handleChange:de,handleRemove:ue,getSuccess:E,getError:I,getLoading:O,validate:q,resetValidation:f,reset:Q,chooseFile:ve,closePreview:me,toSizeUnit:Ae}}});const je=["onClick"],qe=["onClick"],Qe=["src","alt"],Xe=["multiple","accept","capture","disabled"],Ze=["src"];function Ge(e,d,P,B,M,s){const k=S("var-icon"),D=S("var-hover-overlay"),U=S("var-form-details"),F=S("var-popup"),f=_("ripple"),H=_("hover");return p(),c("div",{class:t(e.classes(e.n(),e.n("$--box")))},[V("div",{class:t(e.n("file-list"))},[(p(!0),c(Fe,null,He(e.files,l=>x((p(),c("div",{class:t(e.classes(e.n("file"),e.formatElevation(e.elevation,2),[l.state==="loading",e.n("--loading")])),key:l.id,onClick:g=>e.preview(l)},[V("div",{class:t(e.n("file-name"))},Le(l.name||l.url),3),e.removable?(p(),c("div",{key:0,class:t(e.n("file-close")),onClick:Ne(g=>e.handleRemove(l),["stop"])},[R(k,{class:t(e.n("file-close-icon")),"var-uploader-cover":"",name:"delete"},null,8,["class"])],10,qe)):$("",!0),l.cover?(p(),c("img",{key:1,class:t(e.n("file-cover")),style:ee({objectFit:l.fit}),src:l.cover,alt:l.name},null,14,Qe)):$("",!0),V("div",{class:t(e.n("file-indicator"))},[V("div",{class:t(e.classes(e.n("progress"),[l.state==="success",e.n("--success")],[l.state==="error",e.n("--error")])),style:ee({width:l.state==="success"||l.state==="error"?"100%":`${l.progress}%`})},null,6)],2)],10,je)),[[f,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple}]])),128)),!e.maxlength||e.modelValue.length<e.maxlength?x((p(),c("div",{key:0,class:t(e.classes([!e.$slots.default,`${e.n("action")} ${e.formatElevation(e.elevation,2)}`],[e.disabled||e.formDisabled,e.n("--disabled")])),onClick:d[1]||(d[1]=(...l)=>e.chooseFile&&e.chooseFile(...l))},[V("input",{ref:"input",type:"file",class:t(e.n("action-input")),multiple:e.multiple,accept:e.accept,capture:e.capture,disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly,onChange:d[0]||(d[0]=(...l)=>e.handleChange&&e.handleChange(...l))},null,42,Xe),Te(e.$slots,"default",{},()=>[R(k,{class:t(e.n("action-icon")),"var-uploader-cover":"",name:"plus"},null,8,["class"]),R(D,{hovering:e.hovering&&!e.disabled&&!e.formDisabled},null,8,["hovering"])])],2)),[[f,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple||e.$slots.default}],[H,e.handleHovering,"desktop"]]):$("",!0)],2),R(U,{"error-message":e.errorMessage,"extra-message":e.maxlengthText},null,8,["error-message","extra-message"]),R(F,{class:t(e.n("preview")),"var-uploader-cover":"",position:"center",show:e.showPreview,"onUpdate:show":d[2]||(d[2]=l=>e.showPreview=l),onClosed:d[3]||(d[3]=l=>e.currentPreview=null)},{default:ze(()=>{var l,g;return[e.currentPreview&&e.isHTMLSupportVideo((l=e.currentPreview)==null?void 0:l.url)?(p(),c("video",{key:0,class:t(e.n("preview-video")),playsinline:"true","webkit-playsinline":"true","x5-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"false",controls:"",src:(g=e.currentPreview)==null?void 0:g.url},null,10,Ze)):$("",!0)]}),_:1},8,["class","show"])],2)}const A=Ue(We,[["render",Ge]]);A.install=function(e){e.component(A.name,A)};export{A as U};
